(function(d){function h(a,b){this.element=a;this.$element=d(a);this.settings=d.extend({},k,b);this._defaults=k;this._name="multiSelect";this.init()}var k={containerHTML:'<div class="multi-select-container">',menuHTML:'<div class="multi-select-menu">',buttonHTML:'<span class="multi-select-button">',menuItemsHTML:'<div class="multi-select-menuitems">',menuFieldsetHTML:'<fieldset class="multi-select-fieldset">',menuFieldsetLegendHTML:'<legend class="multi-select-legend">',menuItemHTML:'<label class="multi-select-menuitem">',
presetsHTML:'<div class="multi-select-presets">',modalHTML:void 0,activeClass:"multi-select-container--open",noneText:"-- Select --",allText:void 0,presets:void 0,positionedMenuClass:"multi-select-container--positioned",positionMenuWithin:void 0,viewportBottomGutter:20,menuMinHeight:200,inputClass:void 0};d.extend(h.prototype,{init:function(){this.checkSuitableInput();this.findLabels();this.constructContainer();this.constructButton();this.constructMenu();this.constructModal();this.setUpBodyClickListener();
this.setUpLabelsClickListener();this.hideOriginalElement()},checkSuitableInput:function(a){if(!1===this.$element.is("select[multiple]"))throw Error("$.multiSelect only works on <select multiple> elements");},findLabels:function(){this.$labels=d('label[for="'+this.$element.attr("id")+'"]')},constructContainer:function(){this.$container=d(this.settings.containerHTML);this.$element.data("multi-select-container",this.$container);this.$container.insertAfter(this.$element)},constructButton:function(){var a=
this;this.$button=d(this.settings.buttonHTML);this.$button.attr({role:"button","aria-haspopup":"true","aria-expanded":"false",tabindex:0,"aria-label":this.$labels.eq(0).text()}).on("keydown.multiselect",function(b){var c=b.which;13===c||32===c?(b.preventDefault(),a.$button.click()):40===c?(b.preventDefault(),a.menuShow(),(a.$presets||a.$menuItems).children().first().focus()):27===c&&a.menuHide()}).on("click.multiselect",function(b){a.menuToggle()}).on("blur.multiselect",this.checkBlur.bind(this)).appendTo(this.$container);
this.$element.on("change.multiselect",function(){a.updateButtonContents()});this.updateButtonContents()},updateButtonContents:function(){var a=[],b=[];this.$element.find("option").each(function(){var c=d(this).text();a.push(c);d(this).is(":selected")&&b.push(d.trim(c))});this.$button.empty();0==b.length?this.$button.text(this.settings.noneText):b.length===a.length&&this.settings.allText?this.$button.text(this.settings.allText):this.$button.text(b.join(", "))},constructMenu:function(){var a=this;this.$menu=
d(this.settings.menuHTML);this.$menu.attr({role:"group"}).on("keyup.multiselect",function(b){27===b.which&&(a.menuHide(),a.$button.focus())}).appendTo(this.$container);this.constructMenuItems();this.settings.presets&&this.constructPresets()},constructMenuItems:function(){var a=this;this.$menuItems=d(this.settings.menuItemsHTML);this.$menu.append(this.$menuItems);this.$element.on("change.multiselect",function(b,c){!0!==c&&a.updateMenuItems()});this.updateMenuItems()},updateMenuItems:function(){var a=
this;this.$menuItems.empty();this.$element.children("optgroup,option").each(function(b,c){"OPTION"===c.nodeName?(b=a.constructMenuItem(d(c),b),a.$menuItems.append(b)):a.constructMenuItemsGroup(d(c),b)})},upDown:function(a,b){a=b.which;38===a?(b.preventDefault(),b=b.currentTarget,(a=b.previousElementSibling)&&"LEGEND"===a.nodeName&&(a=null),a||(a=b.parentNode.previousElementSibling),a?"LABEL"===a.nodeName?a.focus():a.lastChild.focus():this.$button.focus()):40===a&&(b.preventDefault(),b=b.currentTarget,
a=b.nextElementSibling,a||(a=b.parentNode.nextElementSibling),a&&("LABEL"===a.nodeName?a.focus():a.querySelector("label").focus()))},constructPresets:function(){var a=this;this.$presets=d(this.settings.presetsHTML);this.$menu.prepend(this.$presets);d.each(this.settings.presets,function(b,c){b=a.$element.attr("name")+"_preset_"+b;var f=d(a.settings.menuItemHTML).attr({"for":b}).text(" "+c.name).on("keydown.multiselect",a.upDown.bind(a,"preset")).appendTo(a.$presets);b=d("<input>").attr({type:"radio",
name:a.$element.attr("name")+"_presets",id:b,"class":this.settings.inputClass}).prependTo(f);c.all&&(c.options=[],a.$element.find("option").each(function(){var e=d(this).val();c.options.push(e)}));b.on("change.multiselect",function(){a.$element.val(c.options);a.$element.trigger("change")}).on("blur.multiselect",a.checkBlur.bind(a))});this.$element.on("change.multiselect",function(){a.updatePresets()});this.updatePresets()},updatePresets:function(){var a=this;d.each(this.settings.presets,function(b,
c){b=a.$element.attr("name")+"_preset_"+b;b=a.$presets.find("#"+b);a:{c=c.options||[];var f=a.$element.val()||[];if(c.length!=f.length)c=!1;else{c.sort();f.sort();for(var e=0;e<c.length;e++)if(c[e]!==f[e]){c=!1;break a}c=!0}}c?b.prop("checked",!0):b.prop("checked",!1)})},constructMenuItemsGroup:function(a,b){var c=this,f=d(c.settings.menuFieldsetHTML),e=a.attr("label");f.attr("data-label",e);e=d(c.settings.menuFieldsetLegendHTML).text(e);f.append(e);a.children("option").each(function(g,l){g=c.constructMenuItem(d(l),
b+"_"+g);f.append(g)});c.$menuItems.append(f)},constructMenuItem:function(a,b){var c=this.$element.attr("name")+"_"+b;b=d(this.settings.menuItemHTML).attr({"for":c}).on("keydown.multiselect",this.upDown.bind(this,"menuitem")).text(" "+a.text());c=d("<input>").attr({type:"checkbox",id:c,value:a.val(),"class":this.settings.inputClass}).prependTo(b);a.is(":disabled")&&c.attr("disabled","disabled");a.is(":selected")&&c.prop("checked","checked");c.on("change.multiselect",function(){d(this).prop("checked")?
a.prop("selected",!0):a.prop("selected",!1);a.trigger("change",[!0])}).on("blur.multiselect",this.checkBlur.bind(this));return b},constructModal:function(){var a=this;this.settings.modalHTML&&(this.$modal=d(this.settings.modalHTML),this.$modal.on("click.multiselect",function(){a.menuHide()}),this.$modal.insertBefore(this.$menu))},setUpBodyClickListener:function(){var a=this;d("html").on("click.multiselect",function(){a.menuHide()});this.$container.on("click.multiselect",function(b){b.stopPropagation()})},
setUpLabelsClickListener:function(){var a=this;this.$labels.on("click.multiselect",function(b){b.preventDefault();b.stopPropagation();a.menuToggle()})},hideOriginalElement:function(){this.$element.hide();this.$labels.removeAttr("for")},menuShow:function(){d("html").trigger("click.multiselect");this.$container.addClass(this.settings.activeClass);this.$button.attr("aria-expanded","true");if(this.settings.positionMenuWithin&&this.settings.positionMenuWithin instanceof d){var a=this.$menu.offset().left+
this.$menu.outerWidth(),b=this.settings.positionMenuWithin.offset().left+this.settings.positionMenuWithin.outerWidth();a>b&&(this.$menu.css("width",b-this.$menu.offset().left),this.$container.addClass(this.settings.positionedMenuClass))}a=this.$menu.offset().top+this.$menu.outerHeight();b=d(window).scrollTop()+d(window).height();a>b-this.settings.viewportBottomGutter?this.$menu.css({maxHeight:Math.max(b-this.settings.viewportBottomGutter-this.$menu.offset().top,this.settings.menuMinHeight),overflow:"scroll"}):
this.$menu.css({maxHeight:"",overflow:""})},menuHide:function(){this.$container.removeClass(this.settings.activeClass);this.$container.removeClass(this.settings.positionedMenuClass);this.$menu.css("width","auto");this.$button.attr("aria-expanded","false")},menuToggle:function(){this.$container.hasClass(this.settings.activeClass)?this.menuHide():this.menuShow()},checkBlur:function(a){a.relatedTarget&&!d(a.relatedTarget).closest(this.$container).length&&this.menuHide()}});d.fn.multiSelect=function(a){return this.each(function(){d.data(this,
"plugin_multiSelect")||d.data(this,"plugin_multiSelect",new h(this,a))})}})(jQuery);